SELECT [Order ID]
       , [AWB Code]
       , Weights                                                                          AS [Total weight as per X (KG)]
       , [Weight slab as per X (KG)]
       , [Charged Weight]                                                                 AS [Total weight as per Courier Company (KG)]
       , [Weight slab charged by Courier Company (KG)]
       , [Delivery Zone as per X]
       , [Delivery Zone charged by Courier Company]
       , [Expected Charge as per X (Rs.)]
       , [Charges Billed by Courier Company (Rs.)]
       , ( [Expected Charge as per X (Rs.)] - [Charges Billed by Courier Company (Rs.)] ) AS [Difference Between Expected Charges and Billed Charges (Rs.)]
FROM   (SELECT k.*
               , CASE
                   WHEN [Delivery Zone as per X] = 'a'
                        AND [Type of Shipment] = 'Forward charges' THEN ( Fixed * 29.5 + AdditionalCharges * 23.6 )
                   WHEN [Delivery Zone as per X] = 'b'
                        AND [Type of Shipment] = 'Forward charges' THEN ( Fixed * 33 + AdditionalCharges * 28.3 )
                   WHEN [Delivery Zone as per X] = 'c'
                        AND [Type of Shipment] = 'Forward charges' THEN ( Fixed * 40.1 + AdditionalCharges * 38.9 )
                   WHEN [Delivery Zone as per X] = 'd'
                        AND [Type of Shipment] = 'Forward charges' THEN ( Fixed * 45.4 + AdditionalCharges * 44.8 )
                   WHEN [Delivery Zone as per X] = 'e'
                        AND [Type of Shipment] = 'Forward charges' THEN ( Fixed * 56.6 + AdditionalCharges * 55.5 )
                   WHEN [Delivery Zone as per X] = 'a'
                        AND [Type of Shipment] = 'Forward and RTO charges' THEN ( Fixed * 29.5 + AdditionalCharges * 23.6 + Fixed * 13.6 + AdditionalCharges * 23.6 )
                   WHEN [Delivery Zone as per X] = 'b'
                        AND [Type of Shipment] = 'Forward and RTO charges' THEN ( Fixed * 33 + AdditionalCharges * 28.3 + Fixed * 20.5 + AdditionalCharges * 28.3 )
                   WHEN [Delivery Zone as per X] = 'c'
                        AND [Type of Shipment] = 'Forward and RTO charges' THEN ( Fixed * 40.1 + AdditionalCharges * 38.9 + Fixed * 31.9 + AdditionalCharges * 39.9 )
                   WHEN [Delivery Zone as per X] = 'd'
                        AND [Type of Shipment] = 'Forward and RTO charges' THEN ( Fixed * 45.4 + AdditionalCharges * 44.8 + Fixed * 41.3 + AdditionalCharges * 44.8 )
                   WHEN [Delivery Zone as per X] = 'e'
                        AND [Type of Shipment] = 'Forward and RTO charges' THEN ( Fixed * 56.6 + AdditionalCharges * 55.5 + Fixed * 50.7 + AdditionalCharges * 55.5 )
                   ELSE 0
                 END AS [Expected Charge as per X (Rs.)]
        FROM   (SELECT j.*
                       , Additional / 0.5 AS AdditionalCharges
                FROM   (SELECT i.*
                               , Ceiling(ChargedWeight * 2) / 2    AS [Weight slab charged by Courier Company (KG)]
                               , [Weight slab as per X (KG)] - 0.5 AS Additional
                               , CASE
                                   WHEN [Weight slab as per X (KG)] > 0 THEN 1
                                   ELSE 0
                                 END                               AS Fixed
                        FROM   (SELECT h.*
                                       , Ceiling(Weights * 2) / 2        AS [Weight slab as per X (KG)]
                                       , Cast([Charged Weight] AS FLOAT) AS ChargedWeight
                                FROM   (SELECT g.*
                                        FROM   (SELECT e.*
                                                       , f.zone AS [Delivery Zone as per X]
                                                FROM   (SELECT [Order ID]
                                                               , [AWB Code]
                                                               , Sum(Weight) / 1000     AS Weights
                                                               , [Charged Weight]
                                                               , [Customer Pincode]
                                                               , Zone                   AS [Delivery Zone charged by Courier Company]
                                                               , [Type of Shipment]
                                                               , [Billing Amount (Rs#)] AS [Charges Billed by Courier Company (Rs.)]
                                                        FROM   (SELECT ExternOrderNo
                                                                       , [Order Qty] * [Weight (g)] AS Weight
                                                                FROM   XorderReport a
                                                                       LEFT JOIN XSKUMaster b
                                                                              ON a.SKU = b.SKU)c
                                                               INNER JOIN Invoice d
                                                                       ON c.ExternOrderNo = d.[Order ID]
                                                        GROUP  BY [Order ID]
                                                                  , [AWB Code]
                                                                  , [Charged Weight]
                                                                  , [Customer Pincode]
                                                                  , Zone
                                                                  , [Type of Shipment]
                                                                  , [Billing Amount (Rs#)])e
                                                       LEFT JOIN XPincodeZones f
                                                              ON e.[Customer Pincode] = f.[Customer Pincode])g)h
                                GROUP  BY [Order ID]
                                          , [AWB Code]
                                          , [Charged Weight]
                                          , [Customer Pincode]
                                          , [Delivery Zone charged by Courier Company]
                                          , [Type of Shipment]
                                          , [Charges Billed by Courier Company (Rs.)]
                                          , [Delivery Zone as per X]
                                          , Weights)i)j)k)l 
